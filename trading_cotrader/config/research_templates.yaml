# Research Templates â€” Unified hypothesis-to-trade pipeline
#
# Each template defines: WHERE to look (universe), WHEN to enter (entry_conditions),
# WHEN to exit (exit_conditions), and HOW to trade (trade_strategy).
#
# Replaces scenario_templates.yaml for research pipeline use.
# Trade templates (config/templates/*.json) remain as-is for leg construction.
#
# Condition operators: gt, gte, lt, lte, eq, between, in
# Indicators resolved from: TechnicalSnapshot, global context, trade context

research_templates:

  # ---------------------------------------------------------------------------
  # MIGRATED FROM SCENARIO TEMPLATES
  # ---------------------------------------------------------------------------

  correction_premium_sell:
    enabled: true
    display_name: "Market Correction - Sell Premium"
    description: "Sell put spreads/strangles when market corrects 8-15% with elevated VIX"
    author: system
    universe: [SPY, QQQ, AAPL, NVDA, MSFT, AMZN, GOOGL, META, TSLA, AMD]
    target_portfolio: research_correction
    cadence: opportunistic
    auto_approve: true

    trade_strategy:
      instrument: option
      strategies:
        - strategy_type: vertical_spread
          option_type: put
          direction: sell
          dte_target: 45
          short_delta: 0.30
          wing_width_pct: 0.05
          confidence: 7
          risk_category: defined
        - strategy_type: strangle
          direction: sell
          dte_target: 45
          delta_target: 0.16
          confidence: 5
          risk_category: undefined

    entry_conditions:
      - indicator: pct_from_52w_high
        operator: between
        value: [-15.0, -8.0]
      - indicator: vix
        operator: between
        value: [22.0, 45.0]
      - indicator: rsi_14
        operator: lte
        value: 40
      - indicator: directional_regime
        operator: in
        value: ["D", "F"]

    exit_conditions:
      - indicator: pnl_pct
        operator: gte
        value: 50
      - indicator: pnl_pct
        operator: lte
        value: -100
      - indicator: days_held
        operator: gte
        value: 38

    variants:
      - variant_id: base
      - variant_id: delta_tight
        overrides:
          short_delta: 0.25
      - variant_id: delta_wide
        overrides:
          short_delta: 0.35

  earnings_iv_crush:
    enabled: true
    display_name: "Earnings IV Crush"
    description: "Sell iron condors/butterflies before earnings to capture IV crush"
    author: system
    universe_from: earnings_calendar
    target_portfolio: research_earnings
    cadence: event_driven
    auto_approve: true

    trade_strategy:
      instrument: option
      strategies:
        - strategy_type: iron_condor
          dte_target: 7
          short_delta: 0.20
          wing_width_pct: 0.08
          confidence: 6
          risk_category: defined
        - strategy_type: iron_butterfly
          dte_target: 7
          confidence: 5
          risk_category: defined

    entry_conditions:
      - indicator: days_to_earnings
        operator: between
        value: [2, 7]
      - indicator: iv_rank
        operator: gte
        value: 60
      - indicator: rsi_14
        operator: between
        value: [35, 65]

    exit_conditions:
      - indicator: pnl_pct
        operator: gte
        value: 50
      - indicator: pnl_pct
        operator: lte
        value: -100
      - indicator: days_held
        operator: gte
        value: 5

    variants:
      - variant_id: base
      - variant_id: dte_short
        overrides:
          dte_target: 7
      - variant_id: dte_long
        overrides:
          dte_target: 21

  black_swan_hedge:
    enabled: true
    display_name: "Black Swan Tail Hedge"
    description: "Buy protective puts during extreme market stress"
    author: system
    universe: [SPY]
    target_portfolio: research_black_swan
    cadence: event_driven
    auto_approve: false

    trade_strategy:
      instrument: option
      strategies:
        - strategy_type: single
          option_type: put
          direction: buy
          dte_target: 30
          delta_target: 0.20
          confidence: 8
          risk_category: defined

    entry_conditions:
      - indicator: vix
        operator: gte
        value: 30
      - indicator: pct_from_52w_high
        operator: lte
        value: -12.0
      - indicator: volatility_regime
        operator: in
        value: ["HIGH"]

    exit_conditions:
      - indicator: pnl_pct
        operator: gte
        value: 200
      - indicator: days_held
        operator: gte
        value: 25

    variants:
      - variant_id: base

  vol_arbitrage_calendar:
    enabled: true
    display_name: "Vol Arbitrage Calendar Spread"
    description: "Exploit IV term structure anomalies via calendar spreads"
    author: system
    universe: [SPY, QQQ, SPX]
    target_portfolio: research_arbitrage
    cadence: opportunistic
    auto_approve: true

    trade_strategy:
      instrument: option
      strategies:
        - strategy_type: calendar_spread
          option_type: call
          near_dte_target: 7
          far_dte_target: 30
          delta_target: 0.40
          confidence: 7
          risk_category: defined
        - strategy_type: double_calendar
          near_dte_target: 7
          far_dte_target: 30
          put_delta: 0.35
          call_delta: 0.35
          confidence: 6
          risk_category: defined

    entry_conditions:
      - indicator: iv_rank
        operator: gte
        value: 50
      - indicator: volatility_regime
        operator: in
        value: ["HIGH", "NORMAL"]
      - indicator: bollinger_width
        operator: gte
        value: 0.04

    exit_conditions:
      - indicator: pnl_pct
        operator: gte
        value: 30
      - indicator: pnl_pct
        operator: lte
        value: -50
      - indicator: days_held
        operator: gte
        value: 5

    variants:
      - variant_id: base
      - variant_id: near_dte_5
        overrides:
          near_dte_target: 5
      - variant_id: near_dte_14
        overrides:
          near_dte_target: 14

  # ---------------------------------------------------------------------------
  # NEW USER-DEFINED TEMPLATES
  # ---------------------------------------------------------------------------

  ma_crossover_rsi:
    enabled: true
    display_name: "MA Crossover + RSI Mean Reversion"
    description: "Buy oversold stocks above 20MA, sell when overbought"
    author: nitin
    universe: [AAPL, MSFT, GOOGL, AMZN, META, NVDA, SPY, QQQ, AMD, TSLA]
    target_portfolio: research_custom

    trade_strategy:
      instrument: equity
      position_type: long

    entry_conditions:
      - indicator: price
        operator: gt
        reference: sma_20
      - indicator: rsi_14
        operator: lte
        value: 30
      - indicator: volume
        operator: gte
        reference: avg_volume_20
        multiplier: 1.5

    exit_conditions:
      - indicator: rsi_14
        operator: gte
        value: 70
      - indicator: pnl_pct
        operator: lte
        value: -5
      - indicator: days_held
        operator: gte
        value: 30

    variants:
      - variant_id: base
      - variant_id: tight_rsi
        overrides:
          entry_rsi_14_value: 25
          exit_rsi_14_value: 75

  bollinger_bounce:
    enabled: true
    display_name: "Bollinger Band Bounce"
    description: "Buy at lower Bollinger, sell at upper Bollinger"
    author: nitin
    universe: [SPY, QQQ, AAPL, MSFT, NVDA]
    target_portfolio: research_custom

    trade_strategy:
      instrument: equity
      position_type: long

    entry_conditions:
      - indicator: price
        operator: lte
        reference: bollinger_lower
      - indicator: rsi_14
        operator: lte
        value: 35
      - indicator: bollinger_width
        operator: gte
        value: 0.03

    exit_conditions:
      - indicator: price
        operator: gte
        reference: bollinger_upper
      - indicator: pnl_pct
        operator: lte
        value: -3
      - indicator: days_held
        operator: gte
        value: 14

    variants:
      - variant_id: base

  high_iv_iron_condor:
    enabled: true
    display_name: "High IV Iron Condor"
    description: "Sell iron condors on high IV rank names for premium collection"
    author: nitin
    universe: [SPY, QQQ, AAPL, MSFT, NVDA, AMD, TSLA, META]
    target_portfolio: research_custom

    trade_strategy:
      instrument: option
      trade_template: monthly_iron_condor
      position_type: short

    entry_conditions:
      - indicator: iv_rank
        operator: gte
        value: 50
      - indicator: rsi_14
        operator: between
        value: [30, 70]
      - indicator: bollinger_width
        operator: gte
        value: 0.04

    exit_conditions:
      - indicator: pnl_pct
        operator: gte
        value: 50
      - indicator: pnl_pct
        operator: lte
        value: -100
      - indicator: days_held
        operator: gte
        value: 35

    variants:
      - variant_id: base
