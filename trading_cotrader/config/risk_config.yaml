# =============================================================================
# Trading CoTrader - Risk Configuration
# =============================================================================
# Source of truth for portfolio definitions, risk limits, exit rules,
# and performance tracking. YAML is config; DB is runtime state.
# =============================================================================

# =============================================================================
# PORTFOLIOS — Real brokerage accounts + WhatIf mirrors
# =============================================================================
# 5 real portfolios (3 USD, 2 INR) + 5 WhatIf mirrors.
# Each portfolio references a broker_firm (key into brokers.yaml).
# WhatIf portfolios inherit strategies from their real parent.

portfolios:
  # -------------------------------------------------------------------------
  # REAL PORTFOLIOS
  # -------------------------------------------------------------------------

  tastytrade:
    display_name: "Tastytrade"
    description: "Active trading account — IC, verticals, 0DTE, calendars, diagonals."
    broker_firm: tastytrade
    account_number: "5WZ78765"
    portfolio_type: real
    currency: USD
    initial_capital: 31360
    target_annual_return_pct: 40
    exit_rule_profile: balanced
    tags: ["active", "options", "short_term"]

    allowed_strategies:
      - single
      - vertical_spread
      - iron_condor
      - iron_butterfly
      - straddle
      - strangle
      - butterfly
      - condor
      - calendar_spread
      - calendar_double_spread
      - diagonal_spread
      - jade_lizard
      - big_lizard
      - ratio_spread

    active_strategies:
      - iron_condor
      - iron_butterfly
      - vertical_spread
      - calendar_spread
      - calendar_double_spread
      - diagonal_spread

    risk_limits:
      max_portfolio_delta: 300
      max_positions: 10
      max_single_position_pct: 25
      max_single_trade_risk_pct: 15
      max_total_risk_pct: 80
      min_cash_reserve_pct: 10
      max_concentration_pct: 30

    preferred_underlyings:
      - SPY
      - QQQ
      - IWM
      - TQQQ
      - NVDA
      - AMD
      - TSLA

  fidelity_ira:
    display_name: "Fidelity IRA"
    description: "Rollover IRA — core holdings, CSP/wheel/covered calls. Conservative long-term."
    broker_firm: fidelity
    account_number: "259510977"
    portfolio_type: real
    currency: USD
    initial_capital: 181067
    target_annual_return_pct: 12.5
    exit_rule_profile: conservative
    tags: ["long_term", "income", "wheel", "ira"]

    allowed_strategies:
      - single
      - covered_call
      - protective_put
      - collar
      - vertical_spread

    active_strategies:
      - single
      - covered_call
      - collar

    risk_limits:
      max_portfolio_delta: 1000
      max_positions: 16
      max_single_position_pct: 10
      max_single_trade_risk_pct: 5
      max_total_risk_pct: 25
      min_cash_reserve_pct: 15
      max_concentration_pct: 10

    preferred_underlyings:
      - SPY
      - QQQ
      - AAPL
      - MSFT
      - GOOGL
      - AMZN
      - NVDA
      - META
      - JPM
      - V

  fidelity_personal:
    display_name: "Fidelity Personal"
    description: "Personal brokerage — medium+high risk strategies."
    broker_firm: fidelity
    account_number: "Z71212342"
    portfolio_type: real
    currency: USD
    initial_capital: 42241
    target_annual_return_pct: 25
    exit_rule_profile: balanced
    tags: ["medium_term", "income", "growth"]

    allowed_strategies:
      - single
      - vertical_spread
      - iron_condor
      - iron_butterfly
      - calendar_spread
      - calendar_double_spread
      - diagonal_spread
      - covered_call
      - collar

    active_strategies:
      - single
      - vertical_spread
      - iron_condor
      - diagonal_spread
      - covered_call

    risk_limits:
      max_portfolio_delta: 500
      max_positions: 10
      max_single_position_pct: 15
      max_single_trade_risk_pct: 10
      max_total_risk_pct: 50
      min_cash_reserve_pct: 10
      max_concentration_pct: 20

    preferred_underlyings:
      - SPY
      - QQQ
      - NVDA
      - AAPL
      - MSFT
      - TSLA

  zerodha:
    display_name: "Zerodha"
    description: "Indian market account — details TBD."
    broker_firm: zerodha
    account_number: "TBD"
    portfolio_type: real
    currency: INR
    initial_capital: 0
    target_annual_return_pct: 0
    exit_rule_profile: balanced
    tags: ["india", "tbd"]

    allowed_strategies: []
    active_strategies: []

    risk_limits:
      max_portfolio_delta: 500
      max_positions: 10
      max_single_position_pct: 20
      max_single_trade_risk_pct: 10
      max_total_risk_pct: 50
      min_cash_reserve_pct: 10
      max_concentration_pct: 25

    preferred_underlyings: []

  stallion:
    display_name: "Stallion Asset"
    description: "Stallion Core Fund (SACF5925) — managed equity portfolio. 29 Indian stocks, INR 50L contribution, managed by Stallion Asset."
    broker_firm: stallion
    account_number: "SACF5925"
    portfolio_type: real
    currency: INR
    initial_capital: 5000000
    target_annual_return_pct: 15
    exit_rule_profile: balanced
    tags: ["india", "equity", "managed_fund", "stallion_core"]

    allowed_strategies:
      - single           # long stock positions (managed by Stallion)

    active_strategies:
      - single

    risk_limits:
      max_portfolio_delta: 1000
      max_positions: 35
      max_single_position_pct: 15
      max_single_trade_risk_pct: 5
      max_total_risk_pct: 100
      min_cash_reserve_pct: 5
      max_concentration_pct: 15

    preferred_underlyings: []

  # -------------------------------------------------------------------------
  # WHATIF MIRRORS — Inherit strategies from real parent
  # -------------------------------------------------------------------------

  tastytrade_whatif:
    display_name: "Tastytrade (WhatIf)"
    description: "Paper mirror of Tastytrade account."
    broker_firm: tastytrade
    account_number: "5WZ78765_whatif"
    portfolio_type: what_if
    mirrors_real: tastytrade
    currency: USD
    initial_capital: 31360
    exit_rule_profile: balanced
    tags: ["whatif", "paper"]
    # strategies inherited from tastytrade (mirrors_real)

    risk_limits:
      max_portfolio_delta: 300
      max_positions: 10
      max_single_position_pct: 25
      max_single_trade_risk_pct: 15
      max_total_risk_pct: 80
      min_cash_reserve_pct: 10
      max_concentration_pct: 30

  fidelity_ira_whatif:
    display_name: "Fidelity IRA (WhatIf)"
    description: "Paper mirror of Fidelity IRA."
    broker_firm: fidelity
    account_number: "259510977_whatif"
    portfolio_type: what_if
    mirrors_real: fidelity_ira
    currency: USD
    initial_capital: 181067
    exit_rule_profile: conservative
    tags: ["whatif", "paper"]

    risk_limits:
      max_portfolio_delta: 1000
      max_positions: 16
      max_single_position_pct: 10
      max_single_trade_risk_pct: 5
      max_total_risk_pct: 25
      min_cash_reserve_pct: 15
      max_concentration_pct: 10

  fidelity_personal_whatif:
    display_name: "Fidelity Personal (WhatIf)"
    description: "Paper mirror of Fidelity Personal."
    broker_firm: fidelity
    account_number: "Z71212342_whatif"
    portfolio_type: what_if
    mirrors_real: fidelity_personal
    currency: USD
    initial_capital: 42241
    exit_rule_profile: balanced
    tags: ["whatif", "paper"]

    risk_limits:
      max_portfolio_delta: 500
      max_positions: 10
      max_single_position_pct: 15
      max_single_trade_risk_pct: 10
      max_total_risk_pct: 50
      min_cash_reserve_pct: 10
      max_concentration_pct: 20

  zerodha_whatif:
    display_name: "Zerodha (WhatIf)"
    description: "Paper mirror of Zerodha account."
    broker_firm: zerodha
    account_number: "TBD_whatif"
    portfolio_type: what_if
    mirrors_real: zerodha
    currency: INR
    initial_capital: 0
    exit_rule_profile: balanced
    tags: ["whatif", "paper", "india"]

    risk_limits:
      max_portfolio_delta: 500
      max_positions: 10
      max_single_position_pct: 20
      max_single_trade_risk_pct: 10
      max_total_risk_pct: 50
      min_cash_reserve_pct: 10
      max_concentration_pct: 25

  stallion_whatif:
    display_name: "Stallion Asset (WhatIf)"
    description: "Paper mirror of Stallion account."
    broker_firm: stallion
    account_number: "SACF5925_whatif"
    portfolio_type: what_if
    mirrors_real: stallion
    currency: INR
    initial_capital: 5000000
    exit_rule_profile: balanced
    tags: ["whatif", "paper", "india"]

    risk_limits:
      max_portfolio_delta: 1000
      max_positions: 35
      max_single_position_pct: 15
      max_single_trade_risk_pct: 5
      max_total_risk_pct: 100
      min_cash_reserve_pct: 5
      max_concentration_pct: 15


# =============================================================================
# PORTFOLIO RISK (global defaults)
# =============================================================================

portfolio_risk:
  var:
    confidence_level: 0.95
    horizon_days: 1
    max_var_percent: 3.0
    warning_threshold: 0.8

  greeks:
    max_portfolio_delta: 500
    max_portfolio_gamma: 50
    max_portfolio_theta_percent: 0.1
    max_portfolio_vega_percent: 1.0

  drawdown:
    max_drawdown_percent: 15
    daily_loss_limit_percent: 3


# =============================================================================
# CONCENTRATION LIMITS
# =============================================================================

concentration:
  single_underlying:
    max_percent: 20
    warning_percent: 15
  strategy_type:
    max_percent: 40
    warning_percent: 30
  direction:
    max_long_percent: 60
    warning_percent: 50
  expiration:
    max_percent: 50
    warning_percent: 40
  sector:
    max_percent: 30
    warning_percent: 25


# =============================================================================
# EXIT RULES (profiles referenced by portfolios)
# =============================================================================

exit_rules:
  profit_targets:
    - name: "conservative_profit"
      target_percent: 50
      applies_to: ["all"]
      priority: 1
      description: "Close at 50% of max profit"

    - name: "aggressive_profit"
      target_percent: 75
      applies_to: ["iron_condor", "iron_butterfly", "strangle"]
      priority: 2
      description: "Let winners run to 75%"

  stop_losses:
    - name: "defined_risk_stop"
      max_loss_percent: 100
      applies_to: ["vertical_spread", "iron_condor", "butterfly"]
      priority: 1
      description: "Defined risk — max loss is known at entry"

    - name: "undefined_risk_stop"
      max_loss_percent: 200
      applies_to: ["single", "strangle", "straddle"]
      priority: 1
      description: "Cut undefined risk at 2x credit received"

  time_based:
    - name: "dte_roll_window"
      days_to_expiry: 21
      applies_to: ["all"]
      priority: 2
      description: "Evaluate for roll at 21 DTE"

    - name: "dte_close_window"
      days_to_expiry: 7
      applies_to: ["all"]
      priority: 1
      description: "Close or roll by 7 DTE"

  delta_based:
    - name: "delta_breach"
      max_delta: 0.30
      applies_to: ["single", "vertical_spread"]
      priority: 2
      description: "Manage when short strike delta exceeds 0.30"

exit_rule_profiles:
  conservative:
    profit_target_pct: 50
    stop_loss_multiplier: 1.0    # 1x credit received
    roll_dte: 21
    close_dte: 10
  balanced:
    profit_target_pct: 65
    stop_loss_multiplier: 1.5
    roll_dte: 14
    close_dte: 7
  aggressive:
    profit_target_pct: 80
    stop_loss_multiplier: 2.0
    roll_dte: 7
    close_dte: 3


# =============================================================================
# UNDERLYINGS
# =============================================================================

underlyings:
  core:
    - symbol: SPY
      description: "S&P 500 ETF"
      sector: "broad_market"
      typical_strategies: ["iron_condor", "vertical_spread", "single"]
    - symbol: QQQ
      description: "Nasdaq 100 ETF"
      sector: "tech"
      typical_strategies: ["iron_condor", "vertical_spread"]
    - symbol: IWM
      description: "Russell 2000 ETF"
      sector: "small_cap"
      typical_strategies: ["iron_condor", "strangle"]

  stocks:
    - symbol: AAPL
      description: "Apple Inc"
      sector: "tech"
      typical_strategies: ["covered_call", "single"]
    - symbol: MSFT
      description: "Microsoft"
      sector: "tech"
      typical_strategies: ["covered_call", "single"]
    - symbol: NVDA
      description: "NVIDIA"
      sector: "semiconductors"
      typical_strategies: ["iron_condor", "strangle", "single"]
    - symbol: TSLA
      description: "Tesla"
      sector: "auto"
      typical_strategies: ["iron_condor", "strangle"]
    - symbol: AMD
      description: "AMD"
      sector: "semiconductors"
      typical_strategies: ["vertical_spread", "single"]
    - symbol: GOOGL
      description: "Alphabet"
      sector: "tech"
      typical_strategies: ["covered_call", "single"]
    - symbol: AMZN
      description: "Amazon"
      sector: "tech"
      typical_strategies: ["covered_call", "single"]
    - symbol: META
      description: "Meta Platforms"
      sector: "tech"
      typical_strategies: ["covered_call", "single"]
    - symbol: JPM
      description: "JPMorgan Chase"
      sector: "financials"
      typical_strategies: ["covered_call", "single"]
    - symbol: V
      description: "Visa"
      sector: "financials"
      typical_strategies: ["covered_call", "single"]


# =============================================================================
# LIQUIDITY THRESHOLDS
# =============================================================================
# Checked before entering trades AND before recommending adjustments/rolls.
# Adjustment thresholds are tighter — if an option is illiquid, recommend
# CLOSE instead of ADJUST/ROLL.

liquidity_thresholds:
  entry:
    min_open_interest: 100
    max_bid_ask_spread_pct: 5.0     # max (ask-bid)/mid * 100
    min_daily_volume: 500
  adjustment:
    min_open_interest: 500
    max_bid_ask_spread_pct: 3.0
    min_daily_volume: 1000


# =============================================================================
# IV SETTINGS
# =============================================================================

iv_settings:
  high_iv_threshold: 50
  very_high_iv_threshold: 70
  low_iv_threshold: 20
  iv_lookback_days: 252


# =============================================================================
# STRATEGY RULES
# =============================================================================

strategy_rules:
  iron_condor:
    min_iv_rank: 30
    preferred_iv_rank: 50
    market_outlook: ["neutral", "range_bound"]
    dte_range: [30, 45]
    entry_filters:
      rsi_range: [30, 70]
      directional_regime: ["F"]
      min_atr_percent: 0.008
  vertical_spread:
    min_iv_rank: 20
    market_outlook: ["bullish", "bearish"]
    dte_range: [30, 45]
    entry_filters:
      rsi_range: [20, 80]
  strangle:
    min_iv_rank: 40
    preferred_iv_rank: 60
    market_outlook: ["neutral"]
    dte_range: [30, 45]
    requires: "undefined_risk_approval"
    entry_filters:
      rsi_range: [30, 70]
      directional_regime: ["F"]
      min_iv_percentile: 40
  iron_butterfly:
    min_iv_rank: 30
    market_outlook: ["neutral"]
    dte_range: [30, 45]
    entry_filters:
      rsi_range: [35, 65]
      directional_regime: ["F"]
  iron_butterfly_0dte:
    min_iv_rank: 20
    market_outlook: ["neutral", "range_bound"]
    dte_range: [0, 0]
    entry_filters:
      rsi_range: [40, 60]
      directional_regime: ["F"]
    profit_target_pct: 50
    stop_loss_multiplier: 1.0
    time_stop: "14:30"
    avoid_events: ["FOMC", "CPI", "PPI", "quad_witching"]
  calendar_spread:
    min_iv_rank: 20
    market_outlook: ["neutral", "slightly_bullish"]
    dte_range: [45, 60]
    entry_filters:
      volatility_regime: ["HIGH"]
  single:
    min_iv_rank: 20
    market_outlook: ["bullish", "bearish", "neutral"]
    dte_range: [30, 60]
  covered_call:
    min_iv_rank: 20
    market_outlook: ["neutral", "slightly_bullish"]
    dte_range: [30, 45]
    requires: "stock_ownership"


# =============================================================================
# MARGIN
# =============================================================================

margin:
  min_buying_power_reserve: 20
  margin_warning_percent: 70
  margin_critical_percent: 85
  max_single_trade_margin_percent: 10


# =============================================================================
# ALERTS
# =============================================================================

alerts:
  enabled:
    - delta_breach
    - var_warning
    - concentration_warning
    - drawdown_warning
    - earnings_proximity
  earnings_warning_days: 7


# =============================================================================
# PERFORMANCE TRACKING
# =============================================================================

performance:
  track_metrics:
    - total_pnl
    - win_rate
    - profit_factor
    - expectancy
    - avg_win
    - avg_loss
    - max_drawdown
    - sharpe_ratio
    - cagr
    - mar_ratio
  track_by:
    - strategy_type
    - underlying
    - risk_category
    - week
    - month
