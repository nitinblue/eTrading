<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trading CoTrader - Risk Monitor</title>
  
  <!-- AG Grid -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/styles/ag-grid.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/styles/ag-theme-balham.css">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-primary: #0a0a0a;
      --bg-secondary: #111111;
      --bg-tertiary: #171717;
      --border: #262626;
      --text-primary: #e5e5e5;
      --text-secondary: #a3a3a3;
      --text-muted: #737373;
      --green: #22c55e;
      --green-dim: #166534;
      --red: #ef4444;
      --red-dim: #991b1b;
      --yellow: #eab308;
      --blue: #3b82f6;
      --purple: #a855f7;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      font-size: 11px;
      height: 100vh;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* ===== HEADER ===== */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .logo {
      font-weight: 700;
      font-size: 13px;
      color: #fff;
      letter-spacing: 1px;
    }
    
    .status-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
    }
    
    .status-dot.warning { background: var(--yellow); }
    .status-dot.error { background: var(--red); }
    
    .refresh-btn {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 4px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-family: inherit;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      transition: all 0.15s;
    }
    
    .refresh-btn:hover { background: var(--border); }
    .refresh-btn:active { transform: scale(0.98); }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
      color: var(--text-muted);
      font-size: 10px;
    }
    
    /* ===== MARKET CONTEXT ===== */
    .market-context {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
    }
    
    .market-row {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    
    .market-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .market-section-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .market-items {
      display: flex;
      gap: 16px;
    }
    
    .market-item {
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    
    .market-symbol { color: var(--text-secondary); font-weight: 500; }
    .market-value { color: var(--text-primary); font-weight: 600; }
    .market-change { font-size: 10px; }
    .market-change.up { color: var(--green); }
    .market-change.down { color: var(--red); }
    
    .regime-bar {
      display: flex;
      gap: 16px;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }
    
    .regime-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .regime-label {
      color: var(--text-muted);
      font-size: 9px;
      text-transform: uppercase;
    }
    
    .regime-value {
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .regime-value.risk_on { background: var(--green-dim); color: var(--green); }
    .regime-value.risk_off { background: var(--red-dim); color: var(--red); }
    .regime-value.neutral { background: var(--border); color: var(--text-secondary); }
    .regime-value.low_stable { background: var(--green-dim); color: var(--green); }
    .regime-value.elevated { background: #854d0e; color: var(--yellow); }
    .regime-value.high { background: var(--red-dim); color: var(--red); }
    .regime-value.inverted { background: var(--red-dim); color: var(--red); }
    
    /* ===== RISK MONITOR ===== */
    .risk-monitor {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    
    .section-title {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }
    
    .risk-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 8px 10px;
    }
    
    .risk-card.breach {
      border-color: var(--red);
      background: rgba(239, 68, 68, 0.1);
    }
    
    .risk-card.warning {
      border-color: var(--yellow);
      background: rgba(234, 179, 8, 0.1);
    }
    
    .risk-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .risk-underlying { font-weight: 600; color: var(--text-primary); }
    
    .risk-status {
      font-size: 9px;
      padding: 1px 6px;
      border-radius: 2px;
    }
    
    .risk-status.ok { background: var(--green-dim); color: var(--green); }
    .risk-status.breach { background: var(--red-dim); color: var(--red); }
    .risk-status.warning { background: #854d0e; color: var(--yellow); }
    
    .risk-metrics {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      font-size: 10px;
    }
    
    .risk-metric { text-align: center; }
    .risk-metric-label { color: var(--text-muted); font-size: 9px; }
    .risk-metric-value { font-weight: 600; }
    .risk-metric-value.negative { color: var(--red); }
    .risk-metric-value.positive { color: var(--green); }
    
    /* ===== SCENARIO MATRIX ===== */
    .scenario-section {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 8px 12px;
    }
    
    .scenario-table {
      font-size: 10px;
      border-collapse: collapse;
    }
    
    .scenario-table th,
    .scenario-table td {
      padding: 4px 8px;
      text-align: right;
      border: 1px solid var(--border);
    }
    
    .scenario-table th {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-weight: 500;
    }
    
    .scenario-table td.positive { color: var(--green); }
    .scenario-table td.negative { color: var(--red); }
    .scenario-table td.current { background: var(--bg-tertiary); }
    
    /* ===== MAIN CONTENT AREA ===== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .positions-section {
      flex: 1;
      padding: 8px 12px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .grid-container {
      flex: 1;
      min-height: 0;
    }
    
    /* ===== HEDGING BLOTTER ===== */
    .hedging-section {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 8px 12px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .hedge-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .hedge-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
    }
    
    .hedge-action {
      font-weight: 600;
      text-transform: uppercase;
      font-size: 10px;
    }
    
    .hedge-action.buy { color: var(--green); }
    .hedge-action.sell { color: var(--red); }
    
    .hedge-details {
      flex: 1;
      display: flex;
      gap: 16px;
      font-size: 10px;
    }
    
    .hedge-impact { color: var(--text-muted); }
    
    .hedge-execute-btn {
      background: var(--blue);
      color: #fff;
      border: none;
      padding: 4px 10px;
      border-radius: 3px;
      font-family: inherit;
      font-size: 9px;
      font-weight: 600;
      cursor: pointer;
      text-transform: uppercase;
    }
    
    .hedge-execute-btn:hover { opacity: 0.9; }
    
    .no-hedges {
      color: var(--text-muted);
      font-size: 10px;
      padding: 8px;
      text-align: center;
    }
    
    /* ===== AG GRID THEME ===== */
    .ag-theme-balham-dark {
      --ag-background-color: var(--bg-primary);
      --ag-header-background-color: var(--bg-tertiary);
      --ag-odd-row-background-color: var(--bg-secondary);
      --ag-row-hover-color: #1a1a1a;
      --ag-selected-row-background-color: #1e3a5f;
      --ag-border-color: var(--border);
      --ag-header-foreground-color: var(--text-muted);
      --ag-foreground-color: var(--text-primary);
      --ag-font-family: 'JetBrains Mono', monospace;
      --ag-font-size: 10px;
    }
    
    .cell-positive { color: var(--green) !important; font-weight: 600; }
    .cell-negative { color: var(--red) !important; font-weight: 600; }
    .cell-muted { color: var(--text-muted) !important; }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <span class="logo">RISK MONITOR</span>
        <div class="status-indicator">
          <span id="status-dot" class="status-dot"></span>
          <span id="status-text">READY</span>
        </div>
        <button id="refresh-btn" class="refresh-btn">⟳ Refresh</button>
      </div>
      <div class="header-right">
        <span id="refresh-count">Refreshes: 0</span>
        <span id="timestamp"></span>
      </div>
    </div>
    
    <!-- Market Context -->
    <div class="market-context">
      <div class="market-row">
        <div class="market-section">
          <span class="market-section-label">Indices</span>
          <div class="market-items" id="indices"></div>
        </div>
        <div class="market-section">
          <span class="market-section-label">Volatility</span>
          <div class="market-items" id="volatility"></div>
        </div>
        <div class="market-section">
          <span class="market-section-label">Rates</span>
          <div class="market-items" id="rates"></div>
        </div>
        <div class="market-section">
          <span class="market-section-label">FX</span>
          <div class="market-items" id="fx"></div>
        </div>
      </div>
      <div class="regime-bar">
        <div class="regime-item">
          <span class="regime-label">Market</span>
          <span id="regime-market" class="regime-value neutral">-</span>
        </div>
        <div class="regime-item">
          <span class="regime-label">Vol</span>
          <span id="regime-vol" class="regime-value neutral">-</span>
        </div>
        <div class="regime-item">
          <span class="regime-label">Curve</span>
          <span id="regime-curve" class="regime-value neutral">-</span>
        </div>
      </div>
    </div>
    
    <!-- Risk Monitor -->
    <div class="risk-monitor">
      <div class="section-header">
        <span class="section-title">Portfolio Greeks (vs Limits)</span>
      </div>
      <div class="risk-grid" id="risk-cards"></div>
    </div>
    
    <!-- Scenario Matrix -->
    <div class="scenario-section">
      <div class="section-header">
        <span class="section-title">Scenario Analysis (SPY)</span>
      </div>
      <div id="scenario-container"></div>
    </div>
    
    <!-- Main Content: Positions Grid -->
    <div class="main-content">
      <div class="positions-section">
        <div class="section-header">
          <span class="section-title">Positions</span>
          <span id="position-count" style="color: var(--text-muted); font-size: 10px;">0 positions</span>
        </div>
        <div id="positions-grid" class="ag-theme-balham-dark grid-container"></div>
      </div>
    </div>
    
    <!-- Hedging Blotter -->
    <div class="hedging-section">
      <div class="section-header">
        <span class="section-title">Hedging Recommendations</span>
      </div>
      <div class="hedge-list" id="hedge-list">
        <div class="no-hedges">No hedges needed - all limits within bounds</div>
      </div>
    </div>
    
  </div>

  <!-- AG Grid -->
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.2/dist/ag-grid-community.min.js"></script>
  
  <script>
    // ============================================================================
    // STATE
    // ============================================================================
    let snapshot = null;
    let positionsGrid = null;
    const API_BASE = 'http://localhost:8000';
    
    // ============================================================================
    // FORMATTERS
    // ============================================================================
    const fmt = {
      price: (v) => v == null ? '-' : '$' + Number(v).toFixed(2),
      pct: (v) => v == null ? '-' : (v >= 0 ? '+' : '') + Number(v).toFixed(2) + '%',
      greek: (v, d=2) => v == null ? '-' : Number(v).toFixed(d),
      bp: (v) => v == null ? '-' : (v >= 0 ? '+' : '') + Number(v).toFixed(0) + 'bp',
      int: (v) => v == null ? '-' : Number(v).toFixed(0)
    };
    
    // ============================================================================
    // RENDER FUNCTIONS
    // ============================================================================
    
    function renderMarketContext(market) {
      if (!market) return;
      
      // Indices
      const indicesHtml = Object.entries(market.indices || {}).map(([sym, q]) => `
        <div class="market-item">
          <span class="market-symbol">${sym}</span>
          <span class="market-value">${fmt.price(q.last)}</span>
          <span class="market-change ${q.change_pct >= 0 ? 'up' : 'down'}">${fmt.pct(q.change_pct)}</span>
        </div>
      `).join('');
      document.getElementById('indices').innerHTML = indicesHtml || '<span class="market-symbol">No data</span>';
      
      // Volatility
      const volHtml = `
        <div class="market-item">
          <span class="market-symbol">VIX</span>
          <span class="market-value">${fmt.greek(market.vix?.value, 1)}</span>
          <span class="market-change ${market.vix?.change >= 0 ? 'up' : 'down'}">${fmt.pct(market.vix?.change_pct)}</span>
        </div>
        ${market.vvix ? `
        <div class="market-item">
          <span class="market-symbol">VVIX</span>
          <span class="market-value">${fmt.greek(market.vvix?.value, 1)}</span>
        </div>` : ''}
        ${market.skew ? `
        <div class="market-item">
          <span class="market-symbol">SKEW</span>
          <span class="market-value">${fmt.int(market.skew?.value)}</span>
        </div>` : ''}
      `;
      document.getElementById('volatility').innerHTML = volHtml;
      
      // Rates
      document.getElementById('rates').innerHTML = `
        <div class="market-item">
          <span class="market-symbol">2s10s</span>
          <span class="market-value">${fmt.int(market.curve_2s10s)}bp</span>
        </div>
        <div class="market-item">
          <span class="market-symbol">MOVE</span>
          <span class="market-value">${fmt.greek(market.move_index, 1)}</span>
        </div>
      `;
      
      // FX
      document.getElementById('fx').innerHTML = `
        <div class="market-item">
          <span class="market-symbol">DXY</span>
          <span class="market-value">${fmt.greek(market.dxy, 1)}</span>
        </div>
      `;
      
      // Regimes
      const regimeMarket = document.getElementById('regime-market');
      regimeMarket.textContent = (market.market_regime || 'neutral').replace('_', '-').toUpperCase();
      regimeMarket.className = 'regime-value ' + (market.market_regime || 'neutral');
      
      const regimeVol = document.getElementById('regime-vol');
      regimeVol.textContent = (market.vol_regime || 'neutral').replace('_', ' ').toUpperCase();
      regimeVol.className = 'regime-value ' + (market.vol_regime || 'neutral');
      
      const regimeCurve = document.getElementById('regime-curve');
      regimeCurve.textContent = (market.curve_regime || 'neutral').toUpperCase();
      regimeCurve.className = 'regime-value ' + (market.curve_regime || 'neutral');
    }
    
    function renderRiskMonitor(riskByUnderlying, portfolioRisk, breaches) {
      const container = document.getElementById('risk-cards');
      
      // Build breach lookup
      const breachMap = {};
      (breaches || []).forEach(b => {
        const key = `${b.limit.underlying}-${b.limit.metric}`;
        breachMap[key] = b;
      });
      
      // Render each underlying + portfolio
      const buckets = { ...riskByUnderlying, 'PORTFOLIO': portfolioRisk };
      
      let html = '';
      for (const [underlying, bucket] of Object.entries(buckets)) {
        if (!bucket) continue;
        
        const deltaKey = `${underlying}-delta`;
        const gammaKey = `${underlying}-gamma`;
        const hasBreach = breachMap[deltaKey]?.severity === 'breach' || 
                          breachMap[deltaKey]?.severity === 'critical' ||
                          breachMap[gammaKey]?.severity === 'breach';
        const hasWarning = breachMap[deltaKey]?.severity === 'warning' || 
                          breachMap[gammaKey]?.severity === 'warning';
        
        const cardClass = hasBreach ? 'breach' : (hasWarning ? 'warning' : '');
        const statusClass = hasBreach ? 'breach' : (hasWarning ? 'warning' : 'ok');
        const statusText = hasBreach ? 'BREACH' : (hasWarning ? 'WARN' : 'OK');
        
        html += `
          <div class="risk-card ${cardClass}">
            <div class="risk-card-header">
              <span class="risk-underlying">${underlying}</span>
              <span class="risk-status ${statusClass}">${statusText}</span>
            </div>
            <div class="risk-metrics">
              <div class="risk-metric">
                <div class="risk-metric-label">Δ</div>
                <div class="risk-metric-value ${bucket.delta < 0 ? 'negative' : 'positive'}">${fmt.greek(bucket.delta, 0)}</div>
              </div>
              <div class="risk-metric">
                <div class="risk-metric-label">Γ</div>
                <div class="risk-metric-value ${bucket.gamma < 0 ? 'negative' : 'positive'}">${fmt.greek(bucket.gamma, 1)}</div>
              </div>
              <div class="risk-metric">
                <div class="risk-metric-label">Θ</div>
                <div class="risk-metric-value ${bucket.theta >= 0 ? 'positive' : 'negative'}">${fmt.price(bucket.theta)}</div>
              </div>
              <div class="risk-metric">
                <div class="risk-metric-label">V</div>
                <div class="risk-metric-value ${bucket.vega >= 0 ? 'positive' : 'negative'}">${fmt.greek(bucket.vega, 0)}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    function renderScenarioMatrix(scenarios) {
      const container = document.getElementById('scenario-container');
      
      const underlying = 'SPY';
      const matrix = scenarios?.[underlying];
      
      if (!matrix || !matrix.pnl_matrix || matrix.pnl_matrix.length === 0) {
        container.innerHTML = '<div class="no-hedges">No scenario data</div>';
        return;
      }
      
      const spotMoves = matrix.spot_scenarios || [-0.02, -0.01, 0, 0.01, 0.02];
      const volMoves = matrix.vol_scenarios || [-2, -1, 0, 1, 2];
      
      let html = `<table class="scenario-table">
        <thead>
          <tr>
            <th>${underlying}</th>
            ${volMoves.map(v => `<th>IV ${v >= 0 ? '+' : ''}${v}pt</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${matrix.pnl_matrix.map((row, i) => `
            <tr>
              <th>Spot ${(spotMoves[i] * 100).toFixed(0)}%</th>
              ${row.map((pnl, j) => {
                const isCenter = spotMoves[i] === 0 && volMoves[j] === 0;
                const cls = isCenter ? 'current' : (pnl >= 0 ? 'positive' : 'negative');
                return `<td class="${cls}">${fmt.price(pnl)}</td>`;
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>`;
      
      container.innerHTML = html;
    }
    
    function renderHedgingBlotter(hedges) {
      const container = document.getElementById('hedge-list');
      
      if (!hedges || hedges.length === 0) {
        container.innerHTML = '<div class="no-hedges">✓ No hedges needed - all limits within bounds</div>';
        return;
      }
      
      const html = hedges.map(h => `
        <div class="hedge-item">
          <span class="hedge-action ${h.action}">${h.action.toUpperCase()}</span>
          <div class="hedge-details">
            <span><strong>${h.quantity}</strong> ${h.underlying} ${h.instrument.replace('_', ' ')}</span>
            <span>@ ${fmt.price(h.estimated_price)}</span>
            <span class="hedge-impact">Δ impact: ${fmt.greek(h.delta_impact, 0)}</span>
            <span class="hedge-impact">${h.rationale}</span>
          </div>
          <button class="hedge-execute-btn" onclick="executeHedge('${h.underlying}', '${h.instrument}', ${h.quantity})">
            Execute
          </button>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }
    
    function renderPositionsGrid(positions) {
      document.getElementById('position-count').textContent = `${positions?.length || 0} positions`;
      
      if (positionsGrid) {
        positionsGrid.setGridOption('rowData', positions || []);
      }
    }
    
    // ============================================================================
    // GRID SETUP
    // ============================================================================
    
    function initPositionsGrid() {
      const columnDefs = [
        { field: 'symbol', headerName: 'Sym', width: 60, pinned: 'left' },
        { field: 'option_type', headerName: 'Type', width: 50, 
          valueFormatter: p => p.value ? p.value[0] : 'STK' },
        { field: 'strike', headerName: 'Strike', width: 65, type: 'numericColumn',
          valueFormatter: p => p.value ? fmt.price(p.value) : '-' },
        { field: 'expiry', headerName: 'Expiry', width: 85 },
        { field: 'dte', headerName: 'DTE', width: 45, type: 'numericColumn' },
        { field: 'quantity', headerName: 'Qty', width: 50, type: 'numericColumn',
          cellClass: p => p.value < 0 ? 'cell-negative' : 'cell-positive' },
        { 
          headerName: 'Market',
          children: [
            { field: 'bid', headerName: 'Bid', width: 60, valueFormatter: p => fmt.price(p.value) },
            { field: 'ask', headerName: 'Ask', width: 60, valueFormatter: p => fmt.price(p.value) },
            { field: 'mark', headerName: 'Mark', width: 60, valueFormatter: p => fmt.price(p.value) },
          ]
        },
        {
          headerName: 'Greeks',
          children: [
            { field: 'greeks.delta', headerName: 'Δ', width: 55, 
              valueGetter: p => p.data.greeks?.delta,
              valueFormatter: p => fmt.greek(p.value, 1),
              cellClass: p => p.value < 0 ? 'cell-negative' : 'cell-positive' },
            { field: 'greeks.gamma', headerName: 'Γ', width: 55,
              valueGetter: p => p.data.greeks?.gamma,
              valueFormatter: p => fmt.greek(p.value, 2) },
            { field: 'greeks.theta', headerName: 'Θ', width: 55,
              valueGetter: p => p.data.greeks?.theta,
              valueFormatter: p => fmt.greek(p.value, 1),
              cellClass: p => p.value >= 0 ? 'cell-positive' : 'cell-negative' },
            { field: 'greeks.vega', headerName: 'V', width: 55,
              valueGetter: p => p.data.greeks?.vega,
              valueFormatter: p => fmt.greek(p.value, 1) },
          ]
        },
        {
          headerName: 'P&L',
          children: [
            { field: 'unrealized_pnl', headerName: 'P&L $', width: 75,
              valueFormatter: p => fmt.price(p.value),
              cellClass: p => p.value >= 0 ? 'cell-positive' : 'cell-negative' },
            { field: 'unrealized_pnl_pct', headerName: 'P&L %', width: 65,
              valueFormatter: p => fmt.pct(p.value),
              cellClass: p => p.value >= 0 ? 'cell-positive' : 'cell-negative' },
          ]
        },
        { field: 'iv', headerName: 'IV', width: 55,
          valueFormatter: p => p.value ? (p.value * 100).toFixed(0) + '%' : '-' },
      ];
      
      const gridOptions = {
        columnDefs,
        rowData: [],
        defaultColDef: {
          sortable: true,
          resizable: true,
          filter: true,
        },
        headerHeight: 28,
        rowHeight: 26,
        groupHeaderHeight: 24,
        animateRows: true,
      };
      
      const gridDiv = document.getElementById('positions-grid');
      positionsGrid = agGrid.createGrid(gridDiv, gridOptions);
    }
    
    // ============================================================================
    // DATA FETCHING
    // ============================================================================
    
    async function fetchSnapshot() {
      const statusDot = document.getElementById('status-dot');
      const statusText = document.getElementById('status-text');
      
      try {
        statusDot.className = 'status-dot warning';
        statusText.textContent = 'LOADING...';
        
        const response = await fetch(`${API_BASE}/snapshot`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        snapshot = await response.json();
        
        // Render everything
        renderMarketContext(snapshot.market);
        renderRiskMonitor(snapshot.risk_by_underlying, snapshot.portfolio_risk, snapshot.breaches);
        renderScenarioMatrix(snapshot.scenarios);
        renderPositionsGrid(snapshot.positions);
        renderHedgingBlotter(snapshot.hedge_recommendations);
        
        // Update header
        document.getElementById('refresh-count').textContent = `Refreshes: ${snapshot.refresh_count}`;
        document.getElementById('timestamp').textContent = new Date(snapshot.timestamp).toLocaleTimeString();
        
        statusDot.className = 'status-dot';
        statusText.textContent = snapshot.is_live ? 'LIVE' : 'REFRESHED';
        
      } catch (err) {
        console.error('Fetch error:', err);
        statusDot.className = 'status-dot error';
        statusText.textContent = 'ERROR - Check console';
      }
    }
    
    async function executeHedge(underlying, instrument, quantity) {
      console.log(`Execute hedge: ${quantity} ${underlying} ${instrument}`);
      alert(`Would execute: ${quantity} ${underlying} ${instrument}\n\nOrder execution not yet implemented.`);
    }
    
    // ============================================================================
    // INIT
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', () => {
      initPositionsGrid();
      fetchSnapshot();
      
      document.getElementById('refresh-btn').addEventListener('click', fetchSnapshot);
      
      // Keyboard shortcut: R to refresh
      document.addEventListener('keydown', (e) => {
        if (e.key === 'r' || e.key === 'R') {
          if (e.target.tagName !== 'INPUT') {
            fetchSnapshot();
          }
        }
      });
      
      // Update timestamp every second
      setInterval(() => {
        if (snapshot?.timestamp) {
          const age = Math.floor((Date.now() - new Date(snapshot.timestamp).getTime()) / 1000);
          document.getElementById('timestamp').textContent = 
            new Date(snapshot.timestamp).toLocaleTimeString() + ` (${age}s ago)`;
        }
      }, 1000);
    });
  </script>
</body>
</html>
