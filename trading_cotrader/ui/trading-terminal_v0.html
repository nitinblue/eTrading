<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoTrader Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/styles/ag-theme-balham-dark.css">
    <style>
        :root {
            --bg-0: #0a0a0a; --bg-1: #0f0f0f; --bg-2: #151515; --bg-3: #1a1a1a; --bg-4: #222;
            --border: #2a2a2a; --text-0: #fff; --text-1: #ccc; --text-2: #777; --text-3: #555;
            --green: #00d26a; --red: #ff4757; --yellow: #ffa502; --blue: #1e90ff;
            --purple: #9b59b6; --cyan: #00bcd4; --orange: #ff6b35;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Consolas', monospace; background: var(--bg-0); color: var(--text-1); font-size: 11px; overflow: hidden; height: 100vh; }

        /* Header */
        .header { background: var(--bg-1); border-bottom: 1px solid var(--border); height: 32px; display: flex; align-items: center; justify-content: space-between; padding: 0 8px; }
        .logo { color: var(--cyan); font-weight: bold; font-size: 12px; letter-spacing: 1px; }
        .header-right { display: flex; align-items: center; gap: 8px; }
        .status { display: flex; align-items: center; gap: 4px; font-size: 9px; color: var(--text-2); }
        .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--red); }
        .dot.on { background: var(--green); }
        .btn { padding: 3px 8px; border: 1px solid var(--border); border-radius: 2px; background: var(--bg-2); color: var(--text-1); font-size: 10px; cursor: pointer; font-family: inherit; }
        .btn:hover { background: var(--bg-3); }
        .btn-primary { background: var(--blue); border-color: var(--blue); color: #fff; }

        /* Top Market Bar */
        .market-bar { display: flex; border-bottom: 1px solid var(--border); height: 90px; }
        .market-section { flex: 1; padding: 6px 8px; border-right: 1px solid var(--border); }
        .market-section:last-child { border-right: none; }
        .section-title { font-size: 9px; color: var(--text-2); text-transform: uppercase; margin-bottom: 4px; letter-spacing: 0.5px; }

        /* Regime Section */
        .regime-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .regime-box { background: var(--bg-2); padding: 4px 6px; border-radius: 2px; }
        .regime-label { font-size: 8px; color: var(--text-2); }
        .regime-value { font-size: 12px; font-weight: bold; }
        .regime-bar { display: flex; gap: 2px; margin-top: 2px; }
        .regime-seg { height: 3px; flex: 1; background: var(--bg-3); border-radius: 1px; }
        .regime-seg.active-up { background: var(--green); }
        .regime-seg.active-down { background: var(--red); }
        .regime-seg.active-flat { background: var(--yellow); }

        /* Macros Section */
        .macros-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .macro-item { background: var(--bg-2); padding: 3px 5px; border-radius: 2px; text-align: center; }
        .macro-sym { font-size: 8px; color: var(--text-2); }
        .macro-price { font-size: 11px; font-weight: bold; }
        .macro-chg { font-size: 9px; }
        .up { color: var(--green); }
        .down { color: var(--red); }

        /* Advice Section */
        .advice-box { background: var(--bg-2); padding: 6px 8px; border-radius: 2px; height: 100%; }
        .advice-header { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .advice-regime { font-size: 10px; font-weight: bold; }
        .advice-text { font-size: 10px; color: var(--text-1); line-height: 1.4; }
        .advice-strategies { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .strat-chip { font-size: 8px; padding: 2px 5px; background: var(--bg-3); border-radius: 2px; color: var(--text-2); }
        .strat-chip.rec { background: rgba(0,210,106,0.2); color: var(--green); }

        /* Main Layout */
        .main { display: flex; height: calc(100vh - 122px); }
        .left-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); }
        .right-panel { width: 380px; display: flex; flex-direction: column; }
        .right-panel.collapsed { width: 0; overflow: hidden; }

        /* Portfolios Row */
        .portfolios { display: flex; border-bottom: 1px solid var(--border); height: 70px; }
        .portfolio { flex: 1; padding: 6px 8px; border-right: 1px solid var(--border); }
        .portfolio:last-child { border-right: none; }
        .pf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .pf-name { font-size: 10px; font-weight: bold; color: var(--text-0); }
        .pf-badge { font-size: 8px; padding: 1px 4px; border-radius: 2px; }
        .pf-badge.live { background: rgba(0,210,106,0.2); color: var(--green); }
        .pf-badge.sim { background: rgba(155,89,182,0.2); color: var(--purple); }
        .pf-metrics { display: flex; gap: 8px; }
        .pf-metric { text-align: center; }
        .pf-val { font-size: 13px; font-weight: bold; }
        .pf-lbl { font-size: 8px; color: var(--text-2); }

        /* Grids */
        .grids { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .grid-row { display: flex; flex: 1; min-height: 0; border-bottom: 1px solid var(--border); }
        .grid-panel { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border); min-width: 0; }
        .grid-panel:last-child { border-right: none; }
        .grid-header { background: var(--bg-2); padding: 3px 6px; font-size: 9px; color: var(--text-2); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        .grid-body { flex: 1; min-height: 0; }

        /* AG Grid */
        .ag-theme-balham-dark {
            --ag-background-color: var(--bg-1); --ag-header-background-color: var(--bg-2);
            --ag-odd-row-background-color: var(--bg-1); --ag-row-hover-color: var(--bg-3);
            --ag-border-color: var(--border); --ag-header-foreground-color: var(--text-2);
            --ag-foreground-color: var(--text-1); --ag-row-height: 22px; --ag-header-height: 24px;
            font-size: 10px;
        }

        /* Order Builder */
        .order-builder { padding: 8px; overflow-y: auto; flex: 1; }
        .ob-section { margin-bottom: 8px; }
        .ob-title { font-size: 10px; font-weight: bold; color: var(--text-0); margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .ob-close { cursor: pointer; color: var(--text-2); }

        /* Strategy Chips */
        .strat-chips { display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px; }
        .strat-chip2 { padding: 4px 8px; background: var(--bg-2); border: 1px solid var(--border); border-radius: 12px; font-size: 9px; cursor: pointer; }
        .strat-chip2:hover { border-color: var(--cyan); }
        .strat-chip2.sel { background: rgba(0,188,212,0.15); border-color: var(--cyan); color: var(--cyan); }
        .strat-chip2.defined { border-left: 2px solid var(--green); }
        .strat-chip2.undefined { border-left: 2px solid var(--red); }

        /* Form */
        .ob-row { display: flex; gap: 6px; margin-bottom: 6px; }
        .ob-field { flex: 1; }
        .ob-field label { display: block; font-size: 8px; color: var(--text-2); margin-bottom: 2px; text-transform: uppercase; }
        .ob-input { width: 100%; background: var(--bg-2); border: 1px solid var(--border); border-radius: 2px; padding: 4px 6px; color: var(--text-1); font-family: inherit; font-size: 10px; }
        .ob-input:focus { outline: none; border-color: var(--cyan); }

        /* Legs */
        .legs-box { background: var(--bg-2); border-radius: 2px; padding: 4px; margin-bottom: 6px; }
        .leg { display: flex; align-items: center; gap: 4px; padding: 4px; background: var(--bg-3); border-radius: 2px; margin-bottom: 2px; font-size: 10px; }
        .leg:last-child { margin-bottom: 0; }
        .leg-side { font-size: 8px; font-weight: bold; padding: 1px 4px; border-radius: 2px; }
        .leg-side.buy { background: rgba(0,210,106,0.2); color: var(--green); }
        .leg-side.sell { background: rgba(255,71,87,0.2); color: var(--red); }
        .leg-info { flex: 1; }
        .leg-greeks { font-size: 9px; color: var(--text-2); }
        .leg-del { color: var(--red); cursor: pointer; }

        /* Payoff */
        .payoff-box { background: var(--bg-2); border-radius: 2px; padding: 6px; margin-bottom: 6px; }
        .payoff-title { font-size: 9px; color: var(--text-2); margin-bottom: 4px; }
        .payoff-canvas { width: 100%; height: 80px; background: var(--bg-3); border-radius: 2px; }
        .payoff-stats { display: flex; gap: 8px; margin-top: 4px; font-size: 9px; }
        .payoff-stat span:first-child { color: var(--text-2); }

        /* Actions */
        .ob-actions { display: flex; gap: 4px; }
        .ob-actions .btn { flex: 1; }
        .btn-success { background: var(--green); border-color: var(--green); color: #fff; }

        /* Tabs */
        .tabs { display: flex; background: var(--bg-1); border-bottom: 1px solid var(--border); }
        .tab { padding: 6px 12px; font-size: 10px; color: var(--text-2); cursor: pointer; border-right: 1px solid var(--border); text-transform: uppercase; }
        .tab:hover { background: var(--bg-2); color: var(--text-1); }
        .tab.active { background: var(--bg-0); color: var(--cyan); border-bottom: 2px solid var(--cyan); }
        .tab-badge { font-size: 8px; padding: 1px 4px; background: var(--cyan); color: var(--bg-0); border-radius: 8px; margin-left: 4px; }

        .tab-content { display: none; flex: 1; flex-direction: column; min-height: 0; }
        .tab-content.active { display: flex; }

        /* Toggle */
        .toggle-ob { position: absolute; right: 8px; top: 130px; z-index: 10; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <span class="logo">COTRADER</span>
        <div class="header-right">
            <div class="status"><span class="dot" id="wsDot"></span><span>WS</span></div>
            <div class="status"><span class="dot" id="brokerDot"></span><span>BROKER</span></div>
            <button class="btn btn-primary" id="syncBtn">SYNC</button>
            <button class="btn" id="refreshBtn">↻</button>
            <button class="btn" id="toggleOB">+ TRADE</button>
        </div>
    </div>

    <!-- Market Bar -->
    <div class="market-bar">
        <!-- Regime -->
        <div class="market-section">
            <div class="section-title">Market Regime</div>
            <div class="regime-grid">
                <div class="regime-box">
                    <div class="regime-label">Direction</div>
                    <div class="regime-value" id="regimeDir" style="color: var(--green)">BULLISH</div>
                    <div class="regime-bar">
                        <div class="regime-seg active-up" id="regUp"></div>
                        <div class="regime-seg" id="regFlat"></div>
                        <div class="regime-seg" id="regDown"></div>
                    </div>
                </div>
                <div class="regime-box">
                    <div class="regime-label">Volatility</div>
                    <div class="regime-value" id="regimeVol" style="color: var(--yellow)">NORMAL</div>
                    <div class="regime-bar">
                        <div class="regime-seg" id="volLow"></div>
                        <div class="regime-seg active-flat" id="volNorm"></div>
                        <div class="regime-seg" id="volHigh"></div>
                    </div>
                </div>
                <div class="regime-box">
                    <div class="regime-label">Trend Strength</div>
                    <div class="regime-value" id="regimeAdx">32</div>
                </div>
                <div class="regime-box">
                    <div class="regime-label">IV Rank</div>
                    <div class="regime-value" id="regimeIvr">45%</div>
                </div>
            </div>
        </div>

        <!-- Macros -->
        <div class="market-section">
            <div class="section-title">Macros</div>
            <div class="macros-grid">
                <div class="macro-item">
                    <div class="macro-sym">SPY</div>
                    <div class="macro-price">591.45</div>
                    <div class="macro-chg up">+0.85%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">QQQ</div>
                    <div class="macro-price">518.22</div>
                    <div class="macro-chg up">+1.12%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">GLD</div>
                    <div class="macro-price">268.50</div>
                    <div class="macro-chg up">+0.32%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">SLV</div>
                    <div class="macro-price">30.15</div>
                    <div class="macro-chg down">-0.21%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">DXY</div>
                    <div class="macro-price">104.25</div>
                    <div class="macro-chg down">-0.15%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">TNX</div>
                    <div class="macro-price">4.52%</div>
                    <div class="macro-chg up">+0.02</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">VIX</div>
                    <div class="macro-price">15.80</div>
                    <div class="macro-chg down">-2.4%</div>
                </div>
                <div class="macro-item">
                    <div class="macro-sym">OIL</div>
                    <div class="macro-price">78.45</div>
                    <div class="macro-chg up">+0.65%</div>
                </div>
            </div>
        </div>

        <!-- Trading Advice -->
        <div class="market-section">
            <div class="section-title">Trading Advice</div>
            <div class="advice-box">
                <div class="advice-header">
                    <span class="advice-regime" style="color: var(--green)">BULLISH + NORMAL VOL</span>
                    <span style="font-size: 9px; color: var(--text-2)">Updated 2m ago</span>
                </div>
                <div class="advice-text">
                    Market showing strength. Consider selling premium on pullbacks. Watch for mean reversion setups in extended names. VIX at 15 suggests fair premium pricing.
                </div>
                <div class="advice-strategies">
                    <span class="strat-chip rec">Put Credit Spread</span>
                    <span class="strat-chip rec">Iron Condor</span>
                    <span class="strat-chip">Covered Call</span>
                    <span class="strat-chip">Jade Lizard</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Portfolios -->
            <div class="portfolios">
                <div class="portfolio">
                    <div class="pf-header">
                        <span class="pf-name">Real Portfolio</span>
                        <span class="pf-badge live">LIVE</span>
                    </div>
                    <div class="pf-metrics">
                        <div class="pf-metric"><div class="pf-val" id="realNlv">$--</div><div class="pf-lbl">Net Liq</div></div>
                        <div class="pf-metric"><div class="pf-val" id="realBp">$--</div><div class="pf-lbl">BP</div></div>
                        <div class="pf-metric"><div class="pf-val" id="realD">--</div><div class="pf-lbl">Δ</div></div>
                        <div class="pf-metric"><div class="pf-val" id="realT">--</div><div class="pf-lbl">Θ</div></div>
                        <div class="pf-metric"><div class="pf-val" id="realV">--</div><div class="pf-lbl">V</div></div>
                        <div class="pf-metric"><div class="pf-val" id="realPnl">--</div><div class="pf-lbl">P&L</div></div>
                    </div>
                </div>
                <div class="portfolio">
                    <div class="pf-header">
                        <span class="pf-name">What-If</span>
                        <span class="pf-badge sim">SIM</span>
                    </div>
                    <div class="pf-metrics">
                        <div class="pf-metric"><div class="pf-val" id="wifCnt">0</div><div class="pf-lbl">Trades</div></div>
                        <div class="pf-metric"><div class="pf-val" id="wifD">0</div><div class="pf-lbl">Δ</div></div>
                        <div class="pf-metric"><div class="pf-val" id="wifG">0</div><div class="pf-lbl">Γ</div></div>
                        <div class="pf-metric"><div class="pf-val" id="wifT">0</div><div class="pf-lbl">Θ</div></div>
                        <div class="pf-metric"><div class="pf-val" id="wifV">0</div><div class="pf-lbl">V</div></div>
                        <div class="pf-metric"><div class="pf-val" id="combD">0</div><div class="pf-lbl">Comb Δ</div></div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <div class="tab active" data-tab="positions">Positions</div>
                <div class="tab" data-tab="trades">Trades</div>
                <div class="tab" data-tab="whatif">What-If</div>
                <div class="tab" data-tab="events">Events</div>
                <div class="tab" data-tab="strats">Strategies</div>
            </div>

            <!-- Tab Contents -->
            <div class="grids">
                <div class="tab-content active" id="tab-positions">
                    <div class="grid-row">
                        <div class="grid-panel" style="max-width: 280px;">
                            <div class="grid-header">Risk by UL</div>
                            <div class="grid-body"><div id="riskGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                        <div class="grid-panel">
                            <div class="grid-header">Positions <span id="posCnt" style="color:var(--text-3)">(0)</span></div>
                            <div class="grid-body"><div id="posGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="tab-trades">
                    <div class="grid-row">
                        <div class="grid-panel">
                            <div class="grid-header">Open Trades</div>
                            <div class="grid-body"><div id="tradesGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="tab-whatif">
                    <div class="grid-row">
                        <div class="grid-panel">
                            <div class="grid-header">What-If Trades</div>
                            <div class="grid-body"><div id="whatifGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                        <div class="grid-panel">
                            <div class="grid-header">Impact Analysis</div>
                            <div class="grid-body"><div id="impactGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="tab-events">
                    <div class="grid-row">
                        <div class="grid-panel">
                            <div class="grid-header">Trade Events</div>
                            <div class="grid-body"><div id="eventsGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                    </div>
                </div>
                <div class="tab-content" id="tab-strats">
                    <div class="grid-row">
                        <div class="grid-panel" style="max-width: 50%;">
                            <div class="grid-header">Strategy Performance</div>
                            <div class="grid-body"><div id="stratPerfGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                        <div class="grid-panel">
                            <div class="grid-header">Patterns</div>
                            <div class="grid-body"><div id="patternsGrid" class="ag-theme-balham-dark" style="height:100%;width:100%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Order Builder -->
        <div class="right-panel" id="rightPanel">
            <div class="order-builder">
                <div class="ob-section">
                    <div class="ob-title">
                        <span>Order Builder <span class="pf-badge sim">WHAT-IF</span></span>
                        <span class="ob-close" id="closeOB">×</span>
                    </div>

                    <!-- Strategy Chips -->
                    <div class="strat-chips">
                        <div class="strat-chip2 defined sel" data-strat="vertical">Vertical</div>
                        <div class="strat-chip2 defined" data-strat="iron_condor">Iron Condor</div>
                        <div class="strat-chip2 defined" data-strat="butterfly">Butterfly</div>
                        <div class="strat-chip2 undefined" data-strat="straddle">Straddle</div>
                        <div class="strat-chip2 undefined" data-strat="strangle">Strangle</div>
                        <div class="strat-chip2 defined" data-strat="calendar">Calendar</div>
                        <div class="strat-chip2" data-strat="custom">Custom</div>
                    </div>

                    <!-- Fields -->
                    <div class="ob-row">
                        <div class="ob-field">
                            <label>Underlying</label>
                            <input type="text" class="ob-input" id="obUl" value="SPY">
                        </div>
                        <div class="ob-field">
                            <label>Expiry</label>
                            <select class="ob-input" id="obExp">
                                <option>Feb 14 (3d)</option>
                                <option>Feb 21 (10d)</option>
                                <option>Mar 21 (38d)</option>
                            </select>
                        </div>
                        <div class="ob-field" style="max-width: 60px;">
                            <label>Qty</label>
                            <input type="number" class="ob-input" id="obQty" value="1" min="1">
                        </div>
                    </div>

                    <!-- Legs -->
                    <div class="legs-box" id="legsBox">
                        <div class="leg">
                            <span class="leg-side sell">SELL</span>
                            <span class="leg-info">PUT $580</span>
                            <span class="leg-greeks">Δ-0.15 Θ+0.12</span>
                            <span class="leg-del">×</span>
                        </div>
                        <div class="leg">
                            <span class="leg-side buy">BUY</span>
                            <span class="leg-info">PUT $575</span>
                            <span class="leg-greeks">Δ-0.10 Θ+0.08</span>
                            <span class="leg-del">×</span>
                        </div>
                    </div>
                    <button class="btn" style="width: 100%; margin-bottom: 6px;">+ Add Leg</button>

                    <!-- Payoff -->
                    <div class="payoff-box">
                        <div class="payoff-title">Payoff @ Expiry</div>
                        <canvas class="payoff-canvas" id="payoffCanvas"></canvas>
                        <div class="payoff-stats">
                            <div class="payoff-stat"><span>Max Profit:</span> <span class="up">$124</span></div>
                            <div class="payoff-stat"><span>Max Loss:</span> <span class="down">-$376</span></div>
                            <div class="payoff-stat"><span>BE:</span> <span>$578.76</span></div>
                        </div>
                    </div>

                    <!-- Net Greeks -->
                    <div class="ob-row" style="background: var(--bg-2); padding: 4px 6px; border-radius: 2px; margin-bottom: 6px;">
                        <div style="flex:1;text-align:center"><div style="font-size:9px;color:var(--text-2)">Net Δ</div><div style="font-weight:bold" id="obNetD">-5.0</div></div>
                        <div style="flex:1;text-align:center"><div style="font-size:9px;color:var(--text-2)">Net Γ</div><div style="font-weight:bold" id="obNetG">0.02</div></div>
                        <div style="flex:1;text-align:center"><div style="font-size:9px;color:var(--text-2)">Net Θ</div><div style="font-weight:bold;color:var(--green)" id="obNetT">+4.0</div></div>
                        <div style="flex:1;text-align:center"><div style="font-size:9px;color:var(--text-2)">Net V</div><div style="font-weight:bold" id="obNetV">-8.0</div></div>
                    </div>

                    <!-- Actions -->
                    <div class="ob-actions">
                        <button class="btn">Reset</button>
                        <button class="btn">Save W-I</button>
                        <button class="btn btn-success">Submit</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@31.0.0/dist/ag-grid-community.min.js"></script>
    <script>
        const WS_URL = 'ws://localhost:8000/ws';
        const API_URL = 'http://localhost:8000';
        let ws = null, grids = {};

        // Formatters
        const numFmt = p => p.value != null ? parseFloat(p.value).toFixed(2) : '';
        const pnlFmt = p => {
            if (p.value == null) return '';
            const v = parseFloat(p.value);
            return `<span style="color:${v >= 0 ? 'var(--green)' : 'var(--red)'}">${v >= 0 ? '+' : ''}${v.toFixed(2)}</span>`;
        };

        // Columns
        const riskCols = [
            { field: 'underlying', headerName: 'UL', width: 55 },
            { field: 'delta', headerName: 'Δ', cellRenderer: numFmt, width: 55 },
            { field: 'theta', headerName: 'Θ', cellRenderer: numFmt, width: 55 },
            { field: 'vega', headerName: 'V', cellRenderer: numFmt, width: 55 },
            { field: 'pnl', headerName: 'P&L', cellRenderer: pnlFmt, width: 65 },
        ];

        const posCols = [
            { field: 'symbol', headerName: 'Symbol', width: 130 },
            { field: 'type', headerName: 'T', width: 35 },
            { field: 'strike', headerName: 'K', cellRenderer: numFmt, width: 50 },
            { field: 'expiry', headerName: 'Exp', width: 70 },
            { field: 'dte', headerName: 'DTE', width: 40 },
            { field: 'qty', headerName: 'Qty', width: 40 },
            { field: 'entry', headerName: 'Entry', cellRenderer: numFmt, width: 55 },
            { field: 'mark', headerName: 'Mark', cellRenderer: numFmt, width: 55 },
            { field: 'delta', headerName: 'Δ', cellRenderer: numFmt, width: 50 },
            { field: 'theta', headerName: 'Θ', cellRenderer: numFmt, width: 50 },
            { field: 'vega', headerName: 'V', cellRenderer: numFmt, width: 50 },
            { field: 'pnl', headerName: 'P&L', cellRenderer: pnlFmt, width: 65 },
        ];

        const tradeCols = [
            { field: 'underlying', headerName: 'UL', width: 55 },
            { field: 'strategy', headerName: 'Strategy', width: 90 },
            { field: 'status', headerName: 'Status', width: 70 },
            { field: 'legs', headerName: 'Legs', width: 40 },
            { field: 'delta', headerName: 'Δ', cellRenderer: numFmt, width: 55 },
            { field: 'theta', headerName: 'Θ', cellRenderer: numFmt, width: 55 },
            { field: 'pnl', headerName: 'P&L', cellRenderer: pnlFmt, width: 70 },
            { field: 'dte', headerName: 'DTE', width: 40 },
        ];

        const eventCols = [
            { field: 'timestamp', headerName: 'Time', width: 120 },
            { field: 'event_type', headerName: 'Type', width: 90 },
            { field: 'underlying', headerName: 'UL', width: 55 },
            { field: 'details', headerName: 'Details', flex: 1 },
        ];

        const impactCols = [
            { field: 'metric', headerName: 'Metric', width: 100 },
            { field: 'real', headerName: 'Real', width: 70 },
            { field: 'whatif', headerName: 'What-If', width: 70 },
            { field: 'combined', headerName: 'Combined', width: 80 },
            { field: 'change', headerName: 'Δ', cellRenderer: pnlFmt, width: 60 },
        ];

        const stratPerfCols = [
            { field: 'strategy', headerName: 'Strategy', width: 100 },
            { field: 'trades', headerName: 'Trades', width: 55 },
            { field: 'win_rate', headerName: 'Win%', width: 55 },
            { field: 'avg_pnl', headerName: 'Avg P&L', cellRenderer: pnlFmt, width: 70 },
            { field: 'total_pnl', headerName: 'Total', cellRenderer: pnlFmt, width: 75 },
        ];

        const patternCols = [
            { field: 'pattern_type', headerName: 'Pattern', width: 100 },
            { field: 'confidence', headerName: 'Conf', width: 55 },
            { field: 'success_rate', headerName: 'Win%', width: 55 },
            { field: 'description', headerName: 'Description', flex: 1 },
        ];

        function initGrids() {
            const opts = { animateRows: true, rowSelection: 'single', suppressCellFocus: true, defaultColDef: { sortable: true, resizable: true }};
            grids.risk = agGrid.createGrid(document.getElementById('riskGrid'), { ...opts, columnDefs: riskCols, rowData: [] });
            grids.pos = agGrid.createGrid(document.getElementById('posGrid'), { ...opts, columnDefs: posCols, rowData: [] });
            grids.trades = agGrid.createGrid(document.getElementById('tradesGrid'), { ...opts, columnDefs: tradeCols, rowData: [] });
            grids.whatif = agGrid.createGrid(document.getElementById('whatifGrid'), { ...opts, columnDefs: tradeCols, rowData: [] });
            grids.events = agGrid.createGrid(document.getElementById('eventsGrid'), { ...opts, columnDefs: eventCols, rowData: [] });
            grids.impact = agGrid.createGrid(document.getElementById('impactGrid'), { ...opts, columnDefs: impactCols, rowData: getImpactData() });
            grids.stratPerf = agGrid.createGrid(document.getElementById('stratPerfGrid'), { ...opts, columnDefs: stratPerfCols, rowData: getStratPerfData() });
            grids.patterns = agGrid.createGrid(document.getElementById('patternsGrid'), { ...opts, columnDefs: patternCols, rowData: [] });
        }

        function getImpactData() {
            return [
                { metric: 'Delta', real: 45, whatif: -5, combined: 40, change: -5 },
                { metric: 'Gamma', real: 2.5, whatif: 0.3, combined: 2.8, change: 0.3 },
                { metric: 'Theta', real: -15, whatif: 4, combined: -11, change: 4 },
                { metric: 'Vega', real: 120, whatif: -20, combined: 100, change: -20 },
            ];
        }

        function getStratPerfData() {
            return [
                { strategy: 'Iron Condor', trades: 45, win_rate: '71%', avg_pnl: 85, total_pnl: 3825 },
                { strategy: 'Vertical', trades: 28, win_rate: '64%', avg_pnl: 120, total_pnl: 3360 },
                { strategy: 'Strangle', trades: 15, win_rate: '67%', avg_pnl: 210, total_pnl: 3150 },
            ];
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            };
        });

        // Strategy chips
        document.querySelectorAll('.strat-chip2').forEach(chip => {
            chip.onclick = () => {
                document.querySelectorAll('.strat-chip2').forEach(c => c.classList.remove('sel'));
                chip.classList.add('sel');
            };
        });

        // Toggle Order Builder
        document.getElementById('toggleOB').onclick = () => document.getElementById('rightPanel').classList.remove('collapsed');
        document.getElementById('closeOB').onclick = () => document.getElementById('rightPanel').classList.add('collapsed');

        // WebSocket
        function connectWS() {
            ws = new WebSocket(WS_URL);
            ws.onopen = () => { document.getElementById('wsDot').classList.add('on'); };
            ws.onclose = () => { document.getElementById('wsDot').classList.remove('on'); setTimeout(connectWS, 3000); };
            ws.onmessage = e => { try { handleMsg(JSON.parse(e.data)); } catch(err) {} };
        }

        function handleMsg(msg) {
            if (msg.type === 'connected') document.getElementById('brokerDot').classList.toggle('on', msg.broker_connected);
            if (msg.type === 'fullRefresh') handleRefresh(msg.data);
        }

        function handleRefresh(data) {
            if (data.riskFactors) grids.risk.setGridOption('rowData', data.riskFactors);
            if (data.positions) { grids.pos.setGridOption('rowData', data.positions); document.getElementById('posCnt').textContent = `(${data.positions.length})`; }
            if (data.portfolios) updatePortfolios(data.portfolios);
            if (data.events) grids.events.setGridOption('rowData', data.events);
        }

        function updatePortfolios(p) {
            if (p.real_portfolio) {
                const r = p.real_portfolio;
                document.getElementById('realNlv').textContent = '$' + Math.round(r.total_equity || 0).toLocaleString();
                document.getElementById('realBp').textContent = '$' + Math.round(r.buying_power || 0).toLocaleString();
                document.getElementById('realD').textContent = (r.delta || 0).toFixed(1);
                document.getElementById('realT').textContent = (r.theta || 0).toFixed(1);
                document.getElementById('realV').textContent = (r.vega || 0).toFixed(1);
                document.getElementById('realPnl').textContent = (r.total_pnl >= 0 ? '+' : '') + (r.total_pnl || 0).toFixed(0);
            }
            if (p.whatif_portfolio) {
                const w = p.whatif_portfolio;
                document.getElementById('wifCnt').textContent = w.trade_count || 0;
                document.getElementById('wifD').textContent = (w.delta || 0).toFixed(1);
                document.getElementById('wifG').textContent = (w.gamma || 0).toFixed(2);
                document.getElementById('wifT').textContent = (w.theta || 0).toFixed(1);
                document.getElementById('wifV').textContent = (w.vega || 0).toFixed(1);
                const rd = p.real_portfolio?.delta || 0;
                document.getElementById('combD').textContent = (rd + (w.delta || 0)).toFixed(1);
            }
        }

        // API
        async function sync() {
            try {
                const r = await fetch(`${API_URL}/api/sync`, { method: 'POST' });
                if (r.ok) document.getElementById('brokerDot').classList.add('on');
            } catch(e) {}
        }

        // Payoff
        function drawPayoff() {
            const c = document.getElementById('payoffCanvas');
            if (!c) return;
            const ctx = c.getContext('2d');
            c.width = c.offsetWidth; c.height = c.offsetHeight;
            ctx.fillStyle = '#1a1a1a'; ctx.fillRect(0, 0, c.width, c.height);

            const strikes = [560, 570, 575, 580, 590, 600];
            const payoffs = [-376, -376, -126, 124, 124, 124];
            const min = Math.min(...payoffs), max = Math.max(...payoffs), range = max - min || 1;
            const zeroY = c.height - ((0 - min) / range) * (c.height - 20) - 10;

            ctx.strokeStyle = '#333'; ctx.setLineDash([3,3]); ctx.beginPath();
            ctx.moveTo(0, zeroY); ctx.lineTo(c.width, zeroY); ctx.stroke(); ctx.setLineDash([]);

            ctx.strokeStyle = '#00d26a'; ctx.lineWidth = 2; ctx.beginPath();
            strikes.forEach((s, i) => {
                const x = (i / (strikes.length - 1)) * (c.width - 20) + 10;
                const y = c.height - ((payoffs[i] - min) / range) * (c.height - 20) - 10;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            initGrids(); connectWS(); drawPayoff();
            document.getElementById('syncBtn').onclick = sync;
            document.getElementById('refreshBtn').onclick = () => fetch(`${API_URL}/api/refresh`, { method: 'POST' });
            window.onresize = drawPayoff;
        });
    </script>
</body>
</html>
